name: Generate Requirements Files

on:
  push:
    branches:
      - main

jobs:
  generate_requirements:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install UV
        uses: astral-sh/setup-uv@v5

      - name: Generate requirements.txt
        run: uv pip compile --output-file requirements.txt pyproject.toml

      - name: Generate requirements_dev.txt
        run: uv pip compile --output-file requirements_dev.txt pyproject.toml --group dev

      - name: Configure Git User
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions Bot"

      - name: Commit Changes
        run: |
          git add requirements.txt requirements_dev.txt
          git commit -m "chore(ci): Update requirements files"

      - name: Create New Branch
        run: git checkout -b update-requirements

      - name: Push Changes to New Branch
        run: git push origin update-requirements

      - name: Create Pull Request
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: 'update-requirements',
              base: 'main',
              title: 'chore(ci): Update requirements files',
              body: 'Automated update of requirements.txt and requirements_dev.txt',
            });
